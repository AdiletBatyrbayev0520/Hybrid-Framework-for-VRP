# API для решения задачи коммивояжера

## Описание

В этом разделе представлены API для решения задачи коммивояжера (TSP) с использованием:
1. Алгоритма Хелда-Карпа (динамическое программирование) - DP API
2. Алгоритма Q-learning (обучение с подкреплением) - RL API

Оба API принимают матрицу расстояний и возвращают оптимальный маршрут.

## Запуск серверов

Для запуска API-серверов используйте скрипт:

```bash
python server_starter.py
```

После запуска серверы будут доступны по следующим адресам:
- DP API (Held-Karp): http://localhost:8000/docs
- RL API (Q-learning): http://localhost:8001/docs

## Тестирование API

Для тестирования API и сравнения алгоритмов используйте скрипт:

```bash
python test_api.py
```

Скрипт тестирования выполняет следующие проверки:
1. Тестирование DP API на матрицах различных размеров
2. Тестирование RL API на матрицах различных размеров
3. Сравнение алгоритмов по времени выполнения и длине найденного маршрута

## Примеры запросов к API

### DP API (Held-Karp)

```bash
curl -X 'POST' \
  'http://localhost:8000/solve' \
  -H 'Content-Type: application/json' \
  -d '{
  "distance_matrix": [
    [0, 10, 15, 20],
    [10, 0, 35, 25],
    [15, 35, 0, 30],
    [20, 25, 30, 0]
  ]
}'
```

### RL API (Q-learning)

Базовый запрос:

```bash
curl -X 'POST' \
  'http://localhost:8001/solve' \
  -H 'Content-Type: application/json' \
  -d '{
  "distance_matrix": [
    [0, 10, 15, 20],
    [10, 0, 35, 25],
    [15, 35, 0, 30],
    [20, 25, 30, 0]
  ],
  "start_city": 0,
  "end_city": 3
}'
```

С указанием пути к весам модели:

```bash
curl -X 'POST' \
  'http://localhost:8001/solve' \
  -H 'Content-Type: application/json' \
  -d '{
  "distance_matrix": [
    [0, 10, 15, 20],
    [10, 0, 35, 25],
    [15, 35, 0, 30],
    [20, 25, 30, 0]
  ],
  "start_city": 0,
  "end_city": 3,
  "weights_path": "путь/к/вашим/весам"
}'
```

## Особенности RL API

1. RL API использует предобученную модель, веса которой хранятся в директории `RL_part/runs/test_3`.
2. Параметры запроса:
   - `distance_matrix` - матрица расстояний между городами (обязательный)
   - `start_city` - индекс начального города (по умолчанию 0)
   - `end_city` - индекс конечного города (по умолчанию 9)
   - `weights_path` - путь к весам модели (по умолчанию "runs/test_3")
3. Если веса не найдены по указанному пути, API попытается найти их в нескольких местах:
   - Прямой путь, указанный в запросе
   - Путь относительно директории модуля
   - Жёстко заданный путь `RL_part/runs/test_3`
4. В случае, если веса не найдены ни по одному из путей, API создаст случайные веса и выполнит маршрутизацию с ними.

## Ограничения

1. DP API: максимальное количество городов - 21 (из-за экспоненциального роста сложности)
2. RL API: требуется указание начального и конечного города для маршрута

## Структура ответа API

Оба API возвращают JSON-ответ следующего формата:

```json
{
  "algorithm": "Название алгоритма",
  "route": ["City_0", "City_1", "City_2", "..."],
  "total_distance": 100.0,
  "execution_time": 0.001,
  "num_cities": 10
}
```

## Требования

- Python 3.8+
- FastAPI
- Uvicorn
- NumPy
- Pandas
- Matplotlib (для визуализации результатов сравнения)

## Устранение неполадок

1. **Ошибка при загрузке весов в RL API**: 
   - Убедитесь, что директория `RL_part/runs/test_3` существует и содержит файлы `q1_weights.txt` и `q2_weights.txt`
   - Попробуйте указать полный путь к весам через параметр `weights_path`

2. **Ошибка при сохранении графиков**:
   - Тест автоматически сохраняет графики сравнения в текущую директорию
   - Убедитесь, что у вас есть права на запись в текущую директорию